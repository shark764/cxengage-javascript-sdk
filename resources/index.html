<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>
  <body>
    <script src="main.js" type="text/javascript"></script>
    <script src="js/jquery.js" type="text/javascript"></script>
    <script src="js/lodash.js" type="text/javascript"></script>
    <script src="js/moment.js" type="text/javascript"></script>

    <div id="login">
      <h1>Login</h1>
      <p>Username</p>
      <input type="text" id="username" value="mjones@liveopscloud.com">
      <p>Password</p>
      <input type="password" id="password" value="password1!">
      <br>
      <br>
      <button onclick="login()">Log in</button>
    </div>

    <div id="tenantSelect" style="display: none;">
      <h1>Tenant Select</h1>
      <select id="tenantList"></select>
      <button onclick="selectTenant()">Select tenant</button>
    </div>

    <div id="toolbar" style="display: none;">
      <h1>Toolbar</h1>
      <button style="display: none;" id="logout" onclick="logout()">Logout</button>

      <h2>Agent State</h2>
      <h3 style="display: none;" id="currentState">Current state: <span></span></h3>
      <button style="display: none;" id="ready" onclick="changePresenceState('ready')">Go ready</button>
      <button style="display: none;" id="notready" onclick="changePresenceState('notready')">Go not ready</button>
      <button style="display: none;" id="offline" onclick="changePresenceState('offline')">Go offline</button>

      <h2>Voice Interaction</h2>
      <button id="answerPhone" onclick="answerPhone()" disabled="true">Answer phone <span></span></button>
      <button id="hangupPhone" onclick="hangupPhone()" disabled="true">Hangup phone</button>
      <button id="endwrapup" onclick="endWrapup()" disabled="true">End wrapup</button>
      <div id="phoneControls" style="display:none;">
        <button id="mute" onclick="toggleMute()">Mute</button>
        <button id="hold" onclick="toggleHold()">Hold</button>
        <button id="recording" onclick="toggleRecording()">Start Recording</button>
        <button id="wrapup" onclick="toggleWrapup()">Wrapup Off</button>
      </div>
      <div id="phoneDetails"></div>

      <h2>Messaging Interactions</h2>
      <div id="msgingWindows"></div>
    </div>

    <script>

    var sdk = cxengage_javascript_sdk.core.init({ "env":"dev", "logLevel":"debug" });
    var tenantList = [];
    var interactions = [];
    var activeTenant = null;
    var agentId = null;
    var sessionId = null;
    var isMuted = false;
    var isOnHold = false;
    var isRecording = false;
    var voiceInteractionId = null;
    var voiceTimer = null;
    var currentState = 'offline';
    var availableStates = ['notready'];
    var wrapupEnabled = false;

    function switchScreens (newScreen) {
      var screens = ['login', 'tenantSelect', 'toolbar'];
      var hideScreens = _.filter(screens, function(i) { return i !== newScreen });
      _.each(hideScreens, function(i) { $('#' + i).hide(); });
      $('#' + newScreen).show();
    }

    function changePresenceState(state) {
      sdk.session.changeState({state: state});
    }

    function updatePresenceState(state, availableStates) {
      $('#currentState span').text(state).show();
      currentState = state;
      availableStates = availableStates;
      _.each(availableStates, function(s) {
        $('#' + s).show();
      });
      $('#' + state).hide();
    }

    function toggleMute() {
        if(isMuted) {
          sdk.interactions.voice.unmute({interactionId: voiceInteractionId});
        } else {
          sdk.interactions.voice.mute({interactionId: voiceInteractionId});
        }
    }

    function toggleHold() {
        if(isOnHold) {
          sdk.interactions.voice.resume({interactionId: voiceInteractionId});
        } else {
          sdk.interactions.voice.hold({interactionId: voiceInteractionId});
        }
    }

    function toggleRecording() {
        if(isRecording) {
          sdk.interactions.voice.endRecording({interactionId: voiceInteractionId});
        } else {
          sdk.interactions.voice.startRecording({interactionId: voiceInteractionId});
        }
    }

    function toggleWrapup() {
      if(wrapupEnabled) {
        sdk.interactions.disableWrapup({interactionId: voiceInteractionId});
      } else {
        sdk.interactions.enableWrapup({interactionId: voiceInteractionId});
      }
    }

    function endWrapup() {
      if(wrapupEnabled) {
        sdk.interactions.endWrapup({interactionId: voiceInteractionId});
      } else {
        console.log("Wrapup is disabled!!!!!");
      }
    }

    function answerPhone() {
        $('#answerPhone').attr('disabled', 'disabled');
        $('#hangupPhone').removeAttr('disabled');
        $('#phoneControls').css('display', 'block');
        clearInterval(voiceTimer);
        $('#answerPhone span').text('');
        acceptInteraction(voiceInteractionId);
    }

    function hangupPhone() {
      $('#hangupPhone').attr('disabled', 'disabled');
      $('#phoneControls').css('display', 'none');
      endInteraction(voiceInteractionId);
    }

    function addVoiceInteraction(interaction) {
      var voiceWindow = $('#voiceDetails');
      voiceInteractionId = interaction.interactionId;
      var timeout = Math.floor((new Date(interaction.timeout).getTime() - new Date().getTime()) / 1000);

      $('#answerPhone').removeAttr('disabled');

      var x = setInterval(function() {
        var timeLeft = timeout--;
        $('#answerPhone span').text('(' + timeLeft + 's remaining)');
        if (timeLeft == 1) {
          $('#answerPhone').attr('disabled','disabled');
        }
        if (timeLeft == 0) {
          clearInterval(x);
        }
      }, 1000);
      voiceTimer = x;

      var initialMessagingHTML = 'BOOP';
      voiceWindow.append(initialMessagingHTML);

    }

    function addMessagingInteraction(interaction) {
      if ($('#' + interaction.interactionId).find().length === 0) {
        var msgingWindows = $('#msgingWindows');
        var iid = interaction.interactionId;
        var timeout = Math.floor((new Date(interaction.timeout).getTime() - new Date().getTime()) / 1000);

        var x = setInterval(function() {
          var timeLeft = timeout--;
          $('#' + iid + ' .acceptBtn span').text('(' + timeLeft + 's remaining)');
          if (timeLeft == 1) {
            $('#' + iid + ' .acceptBtn').attr('disabled','disabled');
          }
          if (timeLeft == 0) {
            clearInterval(x);
          }
        }, 1000);

        console.log(x);

        var initialMessagingHTML = '<div style="margin: 20px; vertical-align: top; padding: 10px; display: inline-block; max-width: 300px; border: 2px solid #000000;" id="' + iid + '">\
          <strong style="width: 100%; text-align: center;">' + iid + '</strong><br><br>\
          <strong>Type:</strong> ' + interaction.channelType + '<br>\
          <strong>Direction:</strong> ' + interaction.direction + '<br>\
          <p><strong>Messages:</strong></p>\
          <ul style="list-style: none; padding: 0; margin: 0;"></ul>\
          <div id="acceptRejectArea">\
            <button class="acceptBtn" onclick="acceptInteraction(\''+iid+'\')">Accept Interaction <span></span></button>\
          </div>\
          <div style="display: none;" id="responseArea">\
            <input class="msgText" type="text"></input>\
            <button onclick="sendMessage(\'' + iid + '\')">Send Message</button><br>\
            <button onclick="endInteraction(\'' + iid + '\')">End Chat</button><br>\
          </div>\
        </div>';
        msgingWindows.append(initialMessagingHTML);
      }
    }

    function sendMessage(iid) {
      var contents = $('#' + iid + ' .msgText').val();
      if (contents.length !== 0) {
        sdk.interactions.messaging.sendMessage({message:contents,interactionId:iid});
        $('#' + iid + ' .msgText').val('');
      }
    }

    function handleWorkAccepted(message) {
      var iid = message.interactionId;
      $('#' + iid + ' #acceptRejectArea').hide();
      $('#' + iid + ' #responseArea').show();
    }

    function endInteraction(iid) {
      sdk.interactions.end({interactionId:iid});
    }

    function handleWorkEnded(message) {
      var iid = message.interactionId;
      if ($('#' + iid).length) {
        $('#' + iid).remove();
      } else {
        $('#answerPhone span').text('');
      }
    }

    function handleWorkRejected(message) {
      var iid = message.interactionId;
      $('#' + iid).remove();
    }

    function acceptInteraction(iid) {
      sdk.interactions.accept({interactionId: iid});
    }

    function addInteraction(interaction) {
      interactions.push(interaction);

      if (interaction.channelType === 'sms' || interaction.channelType === 'messaging') {
        addMessagingInteraction(interaction);
      }
      if (interaction.channelType === 'voice') {
        addVoiceInteraction(interaction);
      }
    }

    function appendMessageImpl(to,mid,person,msg) {
      if ($('#' + mid).find().length === 0) {
        $('#' + to + ' ul').append('<li id="'+mid+'">\
          <p><strong>' + person + '</strong>: ' + msg + '</p>\
        </li>');
      }
    }

    function appendSingleMessage(m) {
      var person = m.from == agentId ? 'Agent' : 'Customer';
      var msg = m.body.text;
      var mid = m.id;
      var to = m.to;
      appendMessageImpl(to,mid,person,msg);
    }

    function appendNewMessages(messages) {
      _.each(messages, function(m) {
        var person = m.payload.from == agentId ? 'Agent' : 'Customer';
        var msg = m.payload.body.text;
        var mid = m.payload.id;
        var to = m.channelId;
        appendMessageImpl(to,mid,person,msg);
      });
    }

    sdk.subscribe('cxengage', function(error, topic, response) {
      console.info('Pub/sub message received from SDK:', topic);
      console.info(response);
      switch (topic) {

        case 'cxengage/authentication/login':
          tenantList = response.tenants;
          agentId = response.userId;
          _.each(tenantList, function(t) {
            $('#tenantList').append('<option value="' + t.tenantId + '">' + t.tenantName + '</option>');
          });
          switchScreens('tenantSelect');
          break;

        case 'cxengage/interactions/work-rejected':
          handleWorkRejected(response);
          break;

        case 'cxengage/interactions/work-ended':
          handleWorkEnded(response);
          $('#endwrapup').attr('disabled', 'disabled');
          break;

        case 'cxengage/messaging/new-message-received':
          appendSingleMessage(response);
          break;

        case 'cxengage/session/state-changed':
          if (response != null)
            updatePresenceState(response.state, response.availableStates);
          else
            console.log(response);
          break;

        case 'cxengage/interactions/work-accepted':
          handleWorkAccepted(response);
          break;

        case 'cxengage/interactions/work-offer':
          addInteraction(response);
          break;

        case 'cxengage/messaging/history':
          appendNewMessages(response);
          break;

        case 'cxengage/session/started':
          if (response != null) {
            sessionId = response.sessionId;
            switchScreens('toolbar');
          }
          else {
            console.log("Broke something");
          }
          break;

        case 'cxengage/session/active-tenant-set':
          activeTenant = response.tenantId;
          break;

        case 'cxengage/voice/hold-started':
          isOnHold = true;
          $('#hold').text('Resume');
          break;

        case 'cxengage/voice/hold-ended':
          isOnHold = false;
          $('#hold').text('Hold');
          break;

        case 'cxengage/voice/mute-started':
          isMuted = true;
          $('#mute').text('Unmute');
          break;

        case 'cxengage/voice/mute-ended':
          isMuted = false;
          $('#mute').text('Mute');
          break;

        case 'cxengage/voice/recording-started':
          isRecording = true;
          $('#recording').text('End Recording');
          break;

        case 'cxengage/voice/recording-ended':
          isRecording = false;
          $('#recording').text('Start Recording');
          break;

        case 'cxengage/interactions/wrapup-details':
          if((response.wrapupEnabled == null) || (response.wrapupEnabled == false)) {
            wrapupEnabled = false;
            $('#wrapup').text('Wrapup Off');
          } else {
            wrapupEnabled = true;
            $('#wrapup').text('Wrapup On');
          }
          break;

        case 'cxengage/interactions/wrapup-started':
          console.log("Began wrapup..." + response);
          $('#endwrapup').removeAttr('disabled');
          break;

        case 'cxengage/errors':
          console.log("Got us an error: " + response);
          break;

        case 'cxengage/contacts/get-response':
          console.log("Contacts response: " + response);
          break;

        case 'cxengage/contacts/search-response':
          console.log("Contacts response: " + response);
          break;

        case 'cxengage/contacts/create-response':
          console.log("Contacts response: " + response);
          break;

        case 'cxengage/contacts/update-response':
          console.log("Contacts response: " + response);
          break;

        case 'cxengage/contacts/delete-response':
          console.log("Contacts response: " + response);
          break;

        case 'cxengage/contacts/list-attributes-response':
          console.log("Attributes: " + response);
          break;

        case 'cxengage/contacts/get-layout-response':
          console.log("layout: " + response);
          break;

        case 'cxengage/contacts/list-layouts-response':
          console.log("Layouts: " + response);
          break;

        case 'cxengage/authentication/logout':
          location.reload();
          break;

        default:
          console.warn('No handler yet for this pubsub msg');
          break;
      }
    });

    function login() {
      sdk.auth.login({ username: $('#username').val(), password:$('#password').val() });
    }

    function logout() {
      sdk.auth.logout();
    }

    function selectTenant() {
      $('#logout').show();
      var selectedTenantId = $('#tenantList').val();
      sdk.session.setActiveTenant({tenantId:selectedTenantId});
    }

    </script>
  </body>
</html>
